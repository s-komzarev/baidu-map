import * as tslib_1 from "tslib";
import { Injectable, Inject } from '@angular/core';
import { isBoolean, isNull, omit } from '../helpers/object';
import { nullCheck } from '../helpers/validate';
import { ScriptLoaderConfig } from './scriptLoader';
import { isMapTypeEnum } from '../types/Map';
import { toPoint } from '../helpers/transformer';
import { ScriptLoader } from './scriptLoader';
let MapService = class MapService {
    constructor(config, loader) {
        this.loader = loader;
        nullCheck(config.ak, 'ak must be provided');
        this.config = config;
        this.map = new Promise((resolve) => {
            this.mapResolver = resolve;
        });
    }
    createMap(el, mapOptions) {
        const URL = `https://api.map.baidu.com/api?v=2.0&ak=${this.config.ak}&callback=baidumapinit`;
        return new Promise(resolve => {
            this.loader.load(URL, true, () => {
                const map = new window.BMap.Map(el, omit(mapOptions, 'mapType'));
                this.setOptions(mapOptions);
                this.mapResolver(map);
                resolve(map);
            });
        });
    }
    setOptions(opts) {
        const { disableDragging, enableScrollWheelZoom, disableDoubleClickZoom, enableKeyboard, enableInertialDragging, enableAutoResize, enableContinuousZoom, disablePinchToZoom } = opts;
        if (isBoolean(disableDragging)) {
            this.map.then(map => map[(disableDragging ? 'disable' : 'enable') + 'Dragging']());
        }
        if (isBoolean(enableScrollWheelZoom)) {
            this.map.then(map => map[(enableScrollWheelZoom ? 'enable' : 'disable') + 'ScrollWheelZoom']());
        }
        if (isBoolean(enableAutoResize)) {
            this.map.then(map => map[(enableAutoResize ? 'enable' : 'disable') + 'AutoResize']());
        }
        if (isBoolean(disableDoubleClickZoom)) {
            this.map.then(map => map[(disableDoubleClickZoom ? 'disable' : 'enable') + 'DoubleClickZoom']());
        }
        if (isBoolean(enableKeyboard)) {
            this.map.then(map => map[(enableKeyboard ? 'enable' : 'disable') + 'Keyboard']());
        }
        if (isBoolean(enableInertialDragging)) {
            this.map.then(map => map[(enableInertialDragging ? 'enable' : 'disable') + 'InertialDragging']());
        }
        if (isBoolean(enableContinuousZoom)) {
            this.map.then(map => map[(enableContinuousZoom ? 'enable' : 'disable') + 'ContinuousZoom']());
        }
        if (isBoolean(disablePinchToZoom)) {
            this.map.then(map => map[(disablePinchToZoom ? 'disable' : 'enable') + 'PinchToZoom']());
        }
        if (!isNull(opts.cursor)) {
            this.map.then(map => map.setDefaultCursor(opts.cursor));
        }
        if (!isNull(opts.draggingCursor)) {
            this.map.then(map => map.setDraggingCursor(opts.draggingCursor));
        }
        if (!isNull(opts.currentCity)) {
            this.map.then(map => map.setCurrentCity(opts.currentCity));
        }
        if (!isNull(opts.centerAndZoom)) {
            this.map.then(map => {
                map.centerAndZoom(toPoint(opts.centerAndZoom), opts.centerAndZoom.zoom);
            });
        }
        if (!isNull(opts.mapType)) {
            this.map.then(map => {
                const realType = isMapTypeEnum(opts.mapType)
                    ? window[opts.mapType]
                    : opts.mapType;
                map.setMapType(realType);
            });
        }
    }
    addOverlay(cb) {
        return this.map.then((map) => {
            const overlay = cb(map);
            map.addOverlay(overlay);
            return { map, overlay };
        });
    }
    removeOverlay(overlay) {
        return this.map.then((map) => {
            map.removeOverlay(overlay);
        });
    }
    addTileLayer(cb) {
        return this.map.then((map) => {
            const tilelayer = cb(map);
            map.addTileLayer(tilelayer);
            return { map, tilelayer };
        });
    }
    removeTileLayer(tilelayer) {
        return this.map.then((map) => {
            map.removeOverlay(tilelayer);
        });
    }
    addControl(cb) {
        return this.map.then((map) => {
            const control = cb(map);
            map.addControl(control);
            return { map, control };
        });
    }
    removeControl(control) {
        return this.map.then((map) => {
            map.removeControl(control);
        });
    }
    getNativeMap() {
        return this.map;
    }
};
MapService.ctorParameters = () => [
    { type: ScriptLoaderConfig, decorators: [{ type: Inject, args: [ScriptLoaderConfig,] }] },
    { type: ScriptLoader }
];
MapService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(0, Inject(ScriptLoaderConfig))
], MapService);
export { MapService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXIyLWJhaWR1LW1hcC8iLCJzb3VyY2VzIjpbImxpYi9wcm92aWRlcnMvbWFwU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDbEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUJBQW1CLENBQUE7QUFDM0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHFCQUFxQixDQUFBO0FBRS9DLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBQ25ELE9BQU8sRUFBNEIsYUFBYSxFQUFFLE1BQU0sY0FBYyxDQUFBO0FBSXRFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQTtBQUVoRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFHN0MsSUFBYSxVQUFVLEdBQXZCLE1BQWEsVUFBVTtJQU1yQixZQUM4QixNQUEwQixFQUM5QyxNQUFvQjtRQUFwQixXQUFNLEdBQU4sTUFBTSxDQUFjO1FBRTVCLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLHFCQUFxQixDQUFDLENBQUE7UUFFM0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUE7UUFFcEIsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLE9BQU8sQ0FBZSxDQUFDLE9BQW1CLEVBQUUsRUFBRTtZQUMzRCxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQTtRQUM1QixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFTSxTQUFTLENBQ2QsRUFBZSxFQUNmLFVBQXNCO1FBRXRCLE1BQU0sR0FBRyxHQUFHLDBDQUEwQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsd0JBQXdCLENBQUE7UUFFNUYsT0FBTyxJQUFJLE9BQU8sQ0FBQyxP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LFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJ1xyXG5pbXBvcnQgeyBpc0Jvb2xlYW4sIGlzTnVsbCwgb21pdCB9IGZyb20gJy4uL2hlbHBlcnMvb2JqZWN0J1xyXG5pbXBvcnQgeyBudWxsQ2hlY2sgfSBmcm9tICcuLi9oZWxwZXJzL3ZhbGlkYXRlJ1xyXG5pbXBvcnQgeyBCQ29udHJvbCB9IGZyb20gJy4uL3R5cGVzL0NvbnRyb2wnXHJcbmltcG9ydCB7IFNjcmlwdExvYWRlckNvbmZpZyB9IGZyb20gJy4vc2NyaXB0TG9hZGVyJ1xyXG5pbXBvcnQgeyBCTWFwSW5zdGFuY2UsIE1hcE9wdGlvbnMsIGlzTWFwVHlwZUVudW0gfSBmcm9tICcuLi90eXBlcy9NYXAnXHJcbmltcG9ydCB7IE92ZXJsYXkgfSBmcm9tICcuLi90eXBlcy9PdmVybGF5J1xyXG5pbXBvcnQgeyBCVGlsZUxheWVyIH0gZnJvbSAnLi4vdHlwZXMvVGlsZUxheWVyJ1xyXG5cclxuaW1wb3J0IHsgdG9Qb2ludCB9IGZyb20gJy4uL2hlbHBlcnMvdHJhbnNmb3JtZXInXHJcblxyXG5pbXBvcnQgeyBTY3JpcHRMb2FkZXIgfSBmcm9tICcuL3NjcmlwdExvYWRlcidcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIE1hcFNlcnZpY2Uge1xyXG4gIHByaXZhdGUgY29uZmlnOiBTY3JpcHRMb2FkZXJDb25maWdcclxuXHJcbiAgcHJpdmF0ZSBtYXA6IFByb21pc2U8Qk1hcEluc3RhbmNlPlxyXG4gIHByaXZhdGUgbWFwUmVzb2x2ZXI6ICh2YWx1ZTogQk1hcEluc3RhbmNlKSA9PiB2b2lkXHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgQEluamVjdChTY3JpcHRMb2FkZXJDb25maWcpIGNvbmZpZzogU2NyaXB0TG9hZGVyQ29uZmlnLFxyXG4gICAgcHJpdmF0ZSBsb2FkZXI6IFNjcmlwdExvYWRlclxyXG4gICkge1xyXG4gICAgbnVsbENoZWNrKGNvbmZpZy5haywgJ2FrIG11c3QgYmUgcHJvdmlkZWQnKVxyXG5cclxuICAgIHRoaXMuY29uZmlnID0gY29uZmlnXHJcblxyXG4gICAgdGhpcy5tYXAgPSBuZXcgUHJvbWlzZTxCTWFwSW5zdGFuY2U+KChyZXNvbHZlOiAoKSA9PiB2b2lkKSA9PiB7XHJcbiAgICAgIHRoaXMubWFwUmVzb2x2ZXIgPSByZXNvbHZlXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGNyZWF0ZU1hcChcclxuICAgIGVsOiBIVE1MRWxlbWVudCxcclxuICAgIG1hcE9wdGlvbnM6IE1hcE9wdGlvbnNcclxuICApOiBQcm9taXNlPEJNYXBJbnN0YW5jZT4ge1xyXG4gICAgY29uc3QgVVJMID0gYGh0dHBzOi8vYXBpLm1hcC5iYWlkdS5jb20vYXBpP3Y9Mi4wJmFrPSR7dGhpcy5jb25maWcuYWt9JmNhbGxiYWNrPWJhaWR1bWFwaW5pdGBcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XHJcbiAgICAgIHRoaXMubG9hZGVyLmxvYWQoVVJMLCB0cnVlLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbWFwID0gbmV3IHdpbmRvdy5CTWFwLk1hcChlbCwgb21pdChtYXBPcHRpb25zLCAnbWFwVHlwZScpKVxyXG4gICAgICAgIHRoaXMuc2V0T3B0aW9ucyhtYXBPcHRpb25zKVxyXG4gICAgICAgIHRoaXMubWFwUmVzb2x2ZXIobWFwKVxyXG4gICAgICAgIHJlc29sdmUobWFwKVxyXG4gICAgICB9KVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzZXRPcHRpb25zKG9wdHM6IE1hcE9wdGlvbnMpOiB2b2lkIHtcclxuICAgIGNvbnN0IHtcclxuICAgICAgZGlzYWJsZURyYWdnaW5nLFxyXG4gICAgICBlbmFibGVTY3JvbGxXaGVlbFpvb20sXHJcbiAgICAgIGRpc2FibGVEb3VibGVDbGlja1pvb20sXHJcbiAgICAgIGVuYWJsZUtleWJvYXJkLFxyXG4gICAgICBlbmFibGVJbmVydGlhbERyYWdnaW5nLFxyXG4gICAgICBlbmFibGVBdXRvUmVzaXplLFxyXG4gICAgICBlbmFibGVDb250aW51b3VzWm9vbSxcclxuICAgICAgZGlzYWJsZVBpbmNoVG9ab29tXHJcbiAgICB9ID0gb3B0c1xyXG5cclxuICAgIGlmIChpc0Jvb2xlYW4oZGlzYWJsZURyYWdnaW5nKSkge1xyXG4gICAgICB0aGlzLm1hcC50aGVuKG1hcCA9PlxyXG4gICAgICAgIG1hcFsoZGlzYWJsZURyYWdnaW5nID8gJ2Rpc2FibGUnIDogJ2VuYWJsZScpICsgJ0RyYWdnaW5nJ10oKVxyXG4gICAgICApXHJcbiAgICB9XHJcbiAgICBpZiAoaXNCb29sZWFuKGVuYWJsZVNjcm9sbFdoZWVsWm9vbSkpIHtcclxuICAgICAgdGhpcy5tYXAudGhlbihtYXAgPT5cclxuICAgICAgICBtYXBbXHJcbiAgICAgICAgICAoZW5hYmxlU2Nyb2xsV2hlZWxab29tID8gJ2VuYWJsZScgOiAnZGlzYWJsZScpICsgJ1Njcm9sbFdoZWVsWm9vbSdcclxuICAgICAgICBdKClcclxuICAgICAgKVxyXG4gICAgfVxyXG4gICAgaWYgKGlzQm9vbGVhbihlbmFibGVBdXRvUmVzaXplKSkge1xyXG4gICAgICB0aGlzLm1hcC50aGVuKG1hcCA9PlxyXG4gICAgICAgIG1hcFsoZW5hYmxlQXV0b1Jlc2l6ZSA/ICdlbmFibGUnIDogJ2Rpc2FibGUnKSArICdBdXRvUmVzaXplJ10oKVxyXG4gICAgICApXHJcbiAgICB9XHJcbiAgICBpZiAoaXNCb29sZWFuKGRpc2FibGVEb3VibGVDbGlja1pvb20pKSB7XHJcbiAgICAgIHRoaXMubWFwLnRoZW4obWFwID0+XHJcbiAgICAgICAgbWFwW1xyXG4gICAgICAgICAgKGRpc2FibGVEb3VibGVDbGlja1pvb20gPyAnZGlzYWJsZScgOiAnZW5hYmxlJykgKyAnRG91YmxlQ2xpY2tab29tJ1xyXG4gICAgICAgIF0oKVxyXG4gICAgICApXHJcbiAgICB9XHJcbiAgICBpZiAoaXNCb29sZWFuKGVuYWJsZUtleWJvYXJkKSkge1xyXG4gICAgICB0aGlzLm1hcC50aGVuKG1hcCA9PlxyXG4gICAgICAgIG1hcFsoZW5hYmxlS2V5Ym9hcmQgPyAnZW5hYmxlJyA6ICdkaXNhYmxlJykgKyAnS2V5Ym9hcmQnXSgpXHJcbiAgICAgIClcclxuICAgIH1cclxuICAgIGlmIChpc0Jvb2xlYW4oZW5hYmxlSW5lcnRpYWxEcmFnZ2luZykpIHtcclxuICAgICAgdGhpcy5tYXAudGhlbihtYXAgPT5cclxuICAgICAgICBtYXBbXHJcbiAgICAgICAgICAoZW5hYmxlSW5lcnRpYWxEcmFnZ2luZyA/ICdlbmFibGUnIDogJ2Rpc2FibGUnKSArICdJbmVydGlhbERyYWdnaW5nJ1xyXG4gICAgICAgIF0oKVxyXG4gICAgICApXHJcbiAgICB9XHJcbiAgICBpZiAoaXNCb29sZWFuKGVuYWJsZUNvbnRpbnVvdXNab29tKSkge1xyXG4gICAgICB0aGlzLm1hcC50aGVuKG1hcCA9PlxyXG4gICAgICAgIG1hcFsoZW5hYmxlQ29udGludW91c1pvb20gPyAnZW5hYmxlJyA6ICdkaXNhYmxlJykgKyAnQ29udGludW91c1pvb20nXSgpXHJcbiAgICAgIClcclxuICAgIH1cclxuICAgIGlmIChpc0Jvb2xlYW4oZGlzYWJsZVBpbmNoVG9ab29tKSkge1xyXG4gICAgICB0aGlzLm1hcC50aGVuKG1hcCA9PlxyXG4gICAgICAgIG1hcFsoZGlzYWJsZVBpbmNoVG9ab29tID8gJ2Rpc2FibGUnIDogJ2VuYWJsZScpICsgJ1BpbmNoVG9ab29tJ10oKVxyXG4gICAgICApXHJcbiAgICB9XHJcbiAgICBpZiAoIWlzTnVsbChvcHRzLmN1cnNvcikpIHtcclxuICAgICAgdGhpcy5tYXAudGhlbihtYXAgPT4gbWFwLnNldERlZmF1bHRDdXJzb3Iob3B0cy5jdXJzb3IpKVxyXG4gICAgfVxyXG4gICAgaWYgKCFpc051bGwob3B0cy5kcmFnZ2luZ0N1cnNvcikpIHtcclxuICAgICAgdGhpcy5tYXAudGhlbihtYXAgPT4gbWFwLnNldERyYWdnaW5nQ3Vyc29yKG9wdHMuZHJhZ2dpbmdDdXJzb3IpKVxyXG4gICAgfVxyXG4gICAgaWYgKCFpc051bGwob3B0cy5jdXJyZW50Q2l0eSkpIHtcclxuICAgICAgdGhpcy5tYXAudGhlbihtYXAgPT4gbWFwLnNldEN1cnJlbnRDaXR5KG9wdHMuY3VycmVudENpdHkpKVxyXG4gICAgfVxyXG4gICAgaWYgKCFpc051bGwob3B0cy5jZW50ZXJBbmRab29tKSkge1xyXG4gICAgICB0aGlzLm1hcC50aGVuKG1hcCA9PiB7XHJcbiAgICAgICAgbWFwLmNlbnRlckFuZFpvb20odG9Qb2ludChvcHRzLmNlbnRlckFuZFpvb20pLCBvcHRzLmNlbnRlckFuZFpvb20uem9vbSlcclxuICAgICAgfSlcclxuICAgIH1cclxuICAgIGlmICghaXNOdWxsKG9wdHMubWFwVHlwZSkpIHtcclxuICAgICAgdGhpcy5tYXAudGhlbihtYXAgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJlYWxUeXBlID0gaXNNYXBUeXBlRW51bShvcHRzLm1hcFR5cGUpXHJcbiAgICAgICAgICA/IHdpbmRvd1tvcHRzLm1hcFR5cGVdXHJcbiAgICAgICAgICA6IG9wdHMubWFwVHlwZVxyXG4gICAgICAgIG1hcC5zZXRNYXBUeXBlKHJlYWxUeXBlKVxyXG4gICAgICB9KVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFkZE92ZXJsYXkoXHJcbiAgICBjYjogKG1hcDogQk1hcEluc3RhbmNlKSA9PiBPdmVybGF5XHJcbiAgKTogUHJvbWlzZTx7IG1hcDogQk1hcEluc3RhbmNlOyBvdmVybGF5OiBPdmVybGF5IH0+IHtcclxuICAgIHJldHVybiB0aGlzLm1hcC50aGVuKChtYXA6IEJNYXBJbnN0YW5jZSkgPT4ge1xyXG4gICAgICBjb25zdCBvdmVybGF5ID0gY2IobWFwKVxyXG4gICAgICBtYXAuYWRkT3ZlcmxheShvdmVybGF5KVxyXG4gICAgICByZXR1cm4geyBtYXAsIG92ZXJsYXkgfVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHB1YmxpYyByZW1vdmVPdmVybGF5KG92ZXJsYXk6IE92ZXJsYXkpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHJldHVybiB0aGlzLm1hcC50aGVuKChtYXA6IEJNYXBJbnN0YW5jZSkgPT4ge1xyXG4gICAgICBtYXAucmVtb3ZlT3ZlcmxheShvdmVybGF5KVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhZGRUaWxlTGF5ZXIoXHJcbiAgICBjYjogKG1hcDogQk1hcEluc3RhbmNlKSA9PiBCVGlsZUxheWVyXHJcbiAgKTogUHJvbWlzZTx7IG1hcDogQk1hcEluc3RhbmNlOyB0aWxlbGF5ZXI6IEJUaWxlTGF5ZXIgfT4ge1xyXG4gICAgcmV0dXJuIHRoaXMubWFwLnRoZW4oKG1hcDogQk1hcEluc3RhbmNlKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRpbGVsYXllciA9IGNiKG1hcClcclxuICAgICAgbWFwLmFkZFRpbGVMYXllcih0aWxlbGF5ZXIpXHJcbiAgICAgIHJldHVybiB7IG1hcCwgdGlsZWxheWVyIH1cclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVtb3ZlVGlsZUxheWVyKHRpbGVsYXllcjogQlRpbGVMYXllcik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIHRoaXMubWFwLnRoZW4oKG1hcDogQk1hcEluc3RhbmNlKSA9PiB7XHJcbiAgICAgIG1hcC5yZW1vdmVPdmVybGF5KHRpbGVsYXllcilcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYWRkQ29udHJvbChcclxuICAgIGNiOiAobWFwOiBCTWFwSW5zdGFuY2UpID0+IEJDb250cm9sXHJcbiAgKTogUHJvbWlzZTx7IG1hcDogQk1hcEluc3RhbmNlOyBjb250cm9sOiBCQ29udHJvbCB9PiB7XHJcbiAgICByZXR1cm4gdGhpcy5tYXAudGhlbigobWFwOiBCTWFwSW5zdGFuY2UpID0+IHtcclxuICAgICAgY29uc3QgY29udHJvbCA9IGNiKG1hcClcclxuICAgICAgbWFwLmFkZENvbnRyb2woY29udHJvbClcclxuICAgICAgcmV0dXJuIHsgbWFwLCBjb250cm9sIH1cclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVtb3ZlQ29udHJvbChjb250cm9sOiBCQ29udHJvbCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIHRoaXMubWFwLnRoZW4oKG1hcDogQk1hcEluc3RhbmNlKSA9PiB7XHJcbiAgICAgIG1hcC5yZW1vdmVDb250cm9sKGNvbnRyb2wpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldE5hdGl2ZU1hcCgpOiBQcm9taXNlPEJNYXBJbnN0YW5jZT4ge1xyXG4gICAgcmV0dXJuIHRoaXMubWFwXHJcbiAgfVxyXG59XHJcbiJdfQ==