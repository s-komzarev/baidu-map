import * as tslib_1 from "tslib";
import { Directive, EventEmitter, Input, Output } from '@angular/core';
import { isNull } from '../helpers/object';
import { toIcon, toMarkerOptions, toPoint, toSize } from '../helpers/transformer';
import { nullCheck } from '../helpers/validate';
import { MapService } from '../providers/mapService';
let MarkerComponent = class MarkerComponent {
    constructor(service) {
        this.service = service;
        this.loaded = new EventEmitter();
        this.clicked = new EventEmitter();
    }
    ngOnInit() {
        nullCheck(this.point, 'point is required for <marker>');
        this.service
            .addOverlay(() => {
            return (this.marker = new window.BMap.Marker(toPoint(this.point), toMarkerOptions(this.options)));
        })
            .then(({ map }) => {
            this.loaded.emit(this.marker);
            this.addListener(this.marker, map);
        })
            .then(() => {
            // workaround: it's weird that postion is set while constructing phase will make click event not working
            this.marker.setPosition(new window.BMap.Point(this.point.lng, this.point.lat));
        });
    }
    ngOnChanges(changes) {
        if (changes.point && !changes.point.isFirstChange()) {
            this.marker.setPosition(toPoint(changes.point.currentValue));
        }
        if (changes.options && !changes.options.isFirstChange()) {
            this.setOptions(changes.options.currentValue);
        }
    }
    ngOnDestroy() {
        this.service.removeOverlay(this.marker);
    }
    setOptions(options) {
        if (isNull(options)) {
            return;
        }
        if (!isNull(options.offset)) {
            this.marker.setOffset(toSize(options.offset));
        }
        if (!isNull(options.icon)) {
            this.marker.setIcon(toIcon(options.icon.imageUrl, options.icon.size, options.icon));
        }
        if (!isNull(options.enableMassClear)) {
            this.marker[(options.enableMassClear ? 'enable' : 'disable') + 'MassClear']();
        }
        if (!isNull(options.enableDragging)) {
            this.marker[(options.enableDragging ? 'enable' : 'disable') + 'Dragging']();
        }
        if (!isNull(options.rotation)) {
            this.marker.setRotation(options.rotation);
        }
        if (!isNull(options.shadow)) {
            this.marker.setShadow(toIcon(options.shadow.imageUrl, options.shadow.size, options.shadow));
        }
        if (!isNull(options.title)) {
            this.marker.setTitle(options.title);
        }
    }
    addListener(marker, map) {
        marker.addEventListener('click', (e) => {
            this.clicked.emit({
                e,
                map,
                marker
            });
        });
    }
};
MarkerComponent.ctorParameters = () => [
    { type: MapService }
];
tslib_1.__decorate([
    Input()
], MarkerComponent.prototype, "point", void 0);
tslib_1.__decorate([
    Input()
], MarkerComponent.prototype, "options", void 0);
tslib_1.__decorate([
    Output()
], MarkerComponent.prototype, "loaded", void 0);
tslib_1.__decorate([
    Output()
], MarkerComponent.prototype, "clicked", void 0);
MarkerComponent = tslib_1.__decorate([
    Directive({
        selector: 'marker'
    })
], MarkerComponent);
export { MarkerComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2VyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXIyLWJhaWR1LW1hcC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL21hcmtlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLEtBQUssRUFJTCxNQUFNLEVBRVAsTUFBTSxlQUFlLENBQUE7QUFFdEIsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBQzFDLE9BQU8sRUFDTCxNQUFNLEVBQ04sZUFBZSxFQUNmLE9BQU8sRUFDUCxNQUFNLEVBQ1AsTUFBTSx3QkFBd0IsQ0FBQTtBQUMvQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUE7QUFDL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFBO0FBUXBELElBQWEsZUFBZSxHQUE1QixNQUFhLGVBQWU7SUFTMUIsWUFBb0IsT0FBbUI7UUFBbkIsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQUxyQixXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQTtRQUMzQixZQUFPLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQTtJQUlKLENBQUM7SUFFcEMsUUFBUTtRQUNiLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLGdDQUFnQyxDQUFDLENBQUE7UUFFdkQsSUFBSSxDQUFDLE9BQU87YUFDVCxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ2YsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FDMUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFDbkIsZUFBZSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FDOUIsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFB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QUFDLENBQ3JFLENBQUE7U0FDRjtRQUNELElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQzFCLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtTQUNwQztJQUNILENBQUM7SUFFTyxXQUFXLENBQUMsTUFBZSxFQUFFLEdBQWlCO1FBQ3BELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFNLEVBQUUsRUFBRTtZQUMxQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztnQkFDaEIsQ0FBQztnQkFDRCxHQUFHO2dCQUNILE1BQU07YUFDUCxDQUFDLENBQUE7UUFDSixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FDRixDQUFBOztZQWpGOEIsVUFBVTs7QUFSOUI7SUFBUixLQUFLLEVBQUU7OENBQXFCO0FBQ3BCO0lBQVIsS0FBSyxFQUFFO2dEQUErQjtBQUU3QjtJQUFULE1BQU0sRUFBRTsrQ0FBb0M7QUFDbkM7SUFBVCxNQUFNLEVBQUU7Z0RBQXFDO0FBTG5DLGVBQWU7SUFIM0IsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLFFBQVE7S0FDbkIsQ0FBQztHQUNXLGVBQWUsQ0EwRjNCO1NBMUZZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSxcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgSW5wdXQsXHJcbiAgT25DaGFuZ2VzLFxyXG4gIE9uRGVzdHJveSxcclxuICBPbkluaXQsXHJcbiAgT3V0cHV0LFxyXG4gIFNpbXBsZUNoYW5nZVxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnXHJcblxyXG5pbXBvcnQgeyBpc051bGwgfSBmcm9tICcuLi9oZWxwZXJzL29iamVjdCdcclxuaW1wb3J0IHtcclxuICB0b0ljb24sXHJcbiAgdG9NYXJrZXJPcHRpb25zLFxyXG4gIHRvUG9pbnQsXHJcbiAgdG9TaXplXHJcbn0gZnJvbSAnLi4vaGVscGVycy90cmFuc2Zvcm1lcidcclxuaW1wb3J0IHsgbnVsbENoZWNrIH0gZnJvbSAnLi4vaGVscGVycy92YWxpZGF0ZSdcclxuaW1wb3J0IHsgTWFwU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9tYXBTZXJ2aWNlJ1xyXG5pbXBvcnQgeyBCTWFwSW5zdGFuY2UgfSBmcm9tICcuLi90eXBlcy9NYXAnXHJcbmltcG9ydCB7IEJNYXJrZXIsIE1hcmtlck9wdGlvbnMgfSBmcm9tICcuLi90eXBlcy9NYXJrZXInXHJcbmltcG9ydCB7IFBvaW50IH0gZnJvbSAnLi4vdHlwZXMvUG9pbnQnXHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ21hcmtlcidcclxufSlcclxuZXhwb3J0IGNsYXNzIE1hcmtlckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG4gIEBJbnB1dCgpIHByaXZhdGUgcG9pbnQ6IFBvaW50XHJcbiAgQElucHV0KCkgcHJpdmF0ZSBvcHRpb25zOiBNYXJrZXJPcHRpb25zXHJcblxyXG4gIEBPdXRwdXQoKSBwcml2YXRlIGxvYWRlZCA9IG5ldyBFdmVudEVtaXR0ZXIoKVxyXG4gIEBPdXRwdXQoKSBwcml2YXRlIGNsaWNrZWQgPSBuZXcgRXZlbnRFbWl0dGVyKClcclxuXHJcbiAgcHJpdmF0ZSBtYXJrZXI6IEJNYXJrZXJcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzZXJ2aWNlOiBNYXBTZXJ2aWNlKSB7fVxyXG5cclxuICBwdWJsaWMgbmdPbkluaXQoKSB7XHJcbiAgICBudWxsQ2hlY2sodGhpcy5wb2ludCwgJ3BvaW50IGlzIHJlcXVpcmVkIGZvciA8bWFya2VyPicpXHJcblxyXG4gICAgdGhpcy5zZXJ2aWNlXHJcbiAgICAgIC5hZGRPdmVybGF5KCgpID0+IHtcclxuICAgICAgICByZXR1cm4gKHRoaXMubWFya2VyID0gbmV3IHdpbmRvdy5CTWFwLk1hcmtlcihcclxuICAgICAgICAgIHRvUG9pbnQodGhpcy5wb2ludCksXHJcbiAgICAgICAgICB0b01hcmtlck9wdGlvbnModGhpcy5vcHRpb25zKVxyXG4gICAgICAgICkpXHJcbiAgICAgIH0pXHJcbiAgICAgIC50aGVuKCh7IG1hcCB9KSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2FkZWQuZW1pdCh0aGlzLm1hcmtlcilcclxuICAgICAgICB0aGlzLmFkZExpc3RlbmVyKHRoaXMubWFya2VyLCBtYXApXHJcbiAgICAgIH0pXHJcbiAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAvLyB3b3JrYXJvdW5kOiBpdCdzIHdlaXJkIHRoYXQgcG9zdGlvbiBpcyBzZXQgd2hpbGUgY29uc3RydWN0aW5nIHBoYXNlIHdpbGwgbWFrZSBjbGljayBldmVudCBub3Qgd29ya2luZ1xyXG4gICAgICAgIHRoaXMubWFya2VyLnNldFBvc2l0aW9uKFxyXG4gICAgICAgICAgbmV3IHdpbmRvdy5CTWFwLlBvaW50KHRoaXMucG9pbnQubG5nLCB0aGlzLnBvaW50LmxhdClcclxuICAgICAgICApXHJcbiAgICAgIH0pXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbmdPbkNoYW5nZXMoY2hhbmdlczogeyBbcHJvcGVydHlOYW1lOiBzdHJpbmddOiBTaW1wbGVDaGFuZ2UgfSkge1xyXG4gICAgaWYgKGNoYW5nZXMucG9pbnQgJiYgIWNoYW5nZXMucG9pbnQuaXNGaXJzdENoYW5nZSgpKSB7XHJcbiAgICAgIHRoaXMubWFya2VyLnNldFBvc2l0aW9uKHRvUG9pbnQoY2hhbmdlcy5wb2ludC5jdXJyZW50VmFsdWUpKVxyXG4gICAgfVxyXG4gICAgaWYgKGNoYW5nZXMub3B0aW9ucyAmJiAhY2hhbmdlcy5vcHRpb25zLmlzRmlyc3RDaGFuZ2UoKSkge1xyXG4gICAgICB0aGlzLnNldE9wdGlvbnMoY2hhbmdlcy5vcHRpb25zLmN1cnJlbnRWYWx1ZSlcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMuc2VydmljZS5yZW1vdmVPdmVybGF5KHRoaXMubWFya2VyKVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRPcHRpb25zKG9wdGlvbnM6IE1hcmtlck9wdGlvbnMpOiB2b2lkIHtcclxuICAgIGlmIChpc051bGwob3B0aW9ucykpIHtcclxuICAgICAgcmV0dXJuXHJcbiAgICB9XHJcbiAgICBpZiAoIWlzTnVsbChvcHRpb25zLm9mZnNldCkpIHtcclxuICAgICAgdGhpcy5tYXJrZXIuc2V0T2Zmc2V0KHRvU2l6ZShvcHRpb25zLm9mZnNldCkpXHJcbiAgICB9XHJcbiAgICBpZiAoIWlzTnVsbChvcHRpb25zLmljb24pKSB7XHJcbiAgICAgIHRoaXMubWFya2VyLnNldEljb24oXHJcbiAgICAgICAgdG9JY29uKG9wdGlvbnMuaWNvbi5pbWFnZVVybCwgb3B0aW9ucy5pY29uLnNpemUsIG9wdGlvbnMuaWNvbilcclxuICAgICAgKVxyXG4gICAgfVxyXG4gICAgaWYgKCFpc051bGwob3B0aW9ucy5lbmFibGVNYXNzQ2xlYXIpKSB7XHJcbiAgICAgIHRoaXMubWFya2VyW1xyXG4gICAgICAgIChvcHRpb25zLmVuYWJsZU1hc3NDbGVhciA/ICdlbmFibGUnIDogJ2Rpc2FibGUnKSArICdNYXNzQ2xlYXInXHJcbiAgICAgIF0oKVxyXG4gICAgfVxyXG4gICAgaWYgKCFpc051bGwob3B0aW9ucy5lbmFibGVEcmFnZ2luZykpIHtcclxuICAgICAgdGhpcy5tYXJrZXJbXHJcbiAgICAgICAgKG9wdGlvbnMuZW5hYmxlRHJhZ2dpbmcgPyAnZW5hYmxlJyA6ICdkaXNhYmxlJykgKyAnRHJhZ2dpbmcnXHJcbiAgICAgIF0oKVxyXG4gICAgfVxyXG4gICAgaWYgKCFpc051bGwob3B0aW9ucy5yb3RhdGlvbikpIHtcclxuICAgICAgdGhpcy5tYXJrZXIuc2V0Um90YXRpb24ob3B0aW9ucy5yb3RhdGlvbilcclxuICAgIH1cclxuICAgIGlmICghaXNOdWxsKG9wdGlvbnMuc2hhZG93KSkge1xyXG4gICAgICB0aGlzLm1hcmtlci5zZXRTaGFkb3coXHJcbiAgICAgICAgdG9JY29uKG9wdGlvbnMuc2hhZG93LmltYWdlVXJsLCBvcHRpb25zLnNoYWRvdy5zaXplLCBvcHRpb25zLnNoYWRvdylcclxuICAgICAgKVxyXG4gICAgfVxyXG4gICAgaWYgKCFpc051bGwob3B0aW9ucy50aXRsZSkpIHtcclxuICAgICAgdGhpcy5tYXJrZXIuc2V0VGl0bGUob3B0aW9ucy50aXRsZSlcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgYWRkTGlzdGVuZXIobWFya2VyOiBCTWFya2VyLCBtYXA6IEJNYXBJbnN0YW5jZSkge1xyXG4gICAgbWFya2VyLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGU6IGFueSkgPT4ge1xyXG4gICAgICB0aGlzLmNsaWNrZWQuZW1pdCh7XHJcbiAgICAgICAgZSxcclxuICAgICAgICBtYXAsXHJcbiAgICAgICAgbWFya2VyXHJcbiAgICAgIH0pXHJcbiAgICB9KVxyXG4gIH1cclxufVxyXG4iXX0=